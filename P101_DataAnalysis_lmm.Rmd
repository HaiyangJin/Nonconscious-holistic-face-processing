---
title: "Data Analysis for P101"
author: "[Haiyang Jin](https://haiyangjin.github.io/)"
date:  "`r format(Sys.time(), '%d-%m-%Y')`"
knit: ""
output: 
  html_document:
      df_print: paged
      number_sections: true
      toc: true
      toc_depth: 4
      toc_float: true
      includes:
          after_body: Utilities/footer.html
version: "5.0"
---

```{r setup, include=FALSE}
## set chunk options
knitr::opts_chunk$set(echo = TRUE)
```

# Preparations
```{r load the related libraries, message=FALSE}
## load libraries
library(magrittr)
library(tidyverse)

# folder names
folder.data <- "data"
folder.nesi <- "NeSI"
folder.output <- "output"
folder.R <- "R"
folder.uti <- "Utilities"
folder.standard <- "standard_design_analysis" 
folder.multiple <- "multiple_data"

# do you want save the data into *.csv files
# saveData = TRUE
saveData = FALSE

rm.Count.rate <- 0.8
rm.RT <- 0.2

```

This is the data analysis for all the four experiments. At first, the data analysis were conducted separately for each experiment. Next, the data of four experiments were analyzed together.

```{r include=FALSE}
# load R files in the R folder
sapply(list.files(folder.R, "*.R", full.names = TRUE, recursive = TRUE), source)

```

```{r name the levels of variables}
# name the levels of variables
viewing.levels <- c("CFS", "monocular", "CatchOnly")
trialtype.levels <- c("CF", "catch")
congruency.levels <- c("congruent", "incongruent")
alignment.levels <- c("aligned", "misaligned")
sameDifferent.levels <- c("same", "different")
facegroups <- c(paste0("F", 1:5), paste0("M", 1:5))

```


# Analysis for all the four experiemnts
```{r load libraries for lmm}
# load libraries for lmm
library(lme4)
library(lmerTest)
library(emmeans)

emm_options(pbkrtest.limit = 1e6, lmerTest.limit = 1e6)

```


## The composite face task
```{r tidy up the dataframe for the composite face task}

load(file.path(folder.nesi, "P101_cf_clean.RData"))

head(df.cf.all)

```


```{r manually set the dummy coding for random effects}
# manually set the dummy coding for random effects
df.cf.all %<>% sdif_coding_P101()  # dummy_coding_P101()

if (saveData) {
  save(df.cf.all, file = file.path(folder.nesi, "P101_cf_clean.RData"))
  # write_csv(df.cf.all, file.path(folder.nesi, "P101_cf_clean.csv"))
}
```

Participants `r rmParticipant` were removed due to distinctive reasons.

### Responses
#### Logit mixed model

##### Maximal model
```{r maximal model for responses}
# maximal model for responses
file.max.resp <- file.path(folder.nesi, "P101_resp_glmm_max.RData")

if (!file.exists(file.max.resp)) {

  glmm.max.resp <- glmer(isCorrect ~ Viewing * Congruency * Alignment * CFS_Cover + WithCatch + 
                           (1 + View_C + Con_C + Ali_C + View_Con + View_Ali + Con_Ali + View_Con_Ali | Participant) +
                           (1 + View_C + Ali_C + Cover_C + View_Ali + View_Cover + Ali_Cover + View_Ali_Cover | Stimuli), 
                         data = df.cf.all,
                         family = binomial(link = "logit"),
                         # verbose = TRUE,
                         control = glmerControl(optCtrl = list(maxfun = 1e6)))
  
  glmm.max1.resp <- re_fit(glmm.max.resp)

} else {
  load(file.max.resp)
}

print(summary(glmm.max1.resp), corr = FALSE)
```


##### Zero-correlation-parameter model
```{r zcp model for responses}
# zero-correlation-parameter model for responses
file.zcp.resp <- file.path(folder.nesi, "P101_resp_glmm_zcp.RData")

if (!file.exists(file.zcp.resp)) {
  glmm.zcp.resp <- update(glmm.max.resp,
                          formula = isCorrect ~ Viewing * Congruency * Alignment * CFS_Cover + WithCatch + 
                           (1 + View_C + Con_C + Ali_C + View_Con + View_Ali + Con_Ali + View_Con_Ali || Participant) +
                           (1 + View_C + Ali_C + Cover_C + View_Ali + View_Cover + Ali_Cover + View_Ali_Cover || Stimuli),
                          verbose = FALSE)
  
  glmm.zcp1.resp <- re_fit(glmm.zcp.resp)

} else {
  load(file.zcp.resp)
}

print(summary(glmm.zcp1.resp), corr = FALSE)
```

```{r}
summary(rePCA(glmm.zcp1.resp))
```


##### Reduced model
```{r reduced model for responses}
# reduced model for responses
file.rdc.resp <- file.path(folder.nesi, "P101_resp_glmm_rdc.RData")

if (!file.exists(file.rdc.resp)) {
  glmm.rdc.resp <- update(glmm.zcp.resp,
                          formula = isCorrect ~ Viewing * Congruency * Alignment + ExpCode +
                            (1 + View_D + Con_D + Ali_D + View_Con + View_Ali + Con_Ali || Participant) +
                            (1 | Stimuli),
                          verbose = FALSE)

  save(glmm.rdc.resp, file = file.rdc.resp)
} else {
  load(file.rdc.resp)
}

print(summary(glmm.rdc1.resp), corr = FALSE)

```

```{r}
anova(glmm.rdc1.resp, glmm.zcp1.resp)
```


##### Extended model
```{r extended model for response}
# extended model for response
file.etd.resp <- file.path(folder.nesi, "P101_resp_glmm_etd.RData")

if (!file.exists(file.etd.resp)) {
  glmm.etd.resp <- update(glmm.rdc.resp,
                         formula = isCorrect ~ Viewing * Congruency * Alignment + ExpCode +
                           (1 + View_D + Con_D + Ali_D + View_Con + View_Ali + Con_Ali | Participant) +
                           (1 | Stimuli),
                         verbose = FALSE,
                         control = glmerControl(optCtrl = list(maxfun = 1e6)))
  
  glmm.etd1.resp <- re_fit(glmm.etd.resp)

} else {
  load(file.etd.resp)
}

print(summary(glmm.etd1.resp), corr = FALSE)
```

```{r}
summary(rePCA(glmm.etd1.resp))
```

```{r extended model3 for response}
# extended model for response
file.etd2.resp <- file.path(folder.nesi, "P101_resp_glmm_etd2.RData")

if (!file.exists(file.etd2.resp)) {
  glmm.etd2.resp <- update(glmm.etd.resp,
                         formula = isCorrect ~ Viewing * Congruency * Alignment + ExpCode +
                           (1 + View_D + Ali_D + View_Con + View_Ali + Con_Ali | Participant) +
                           (1 | Stimuli),
                         verbose = FALSE,
                         control = glmerControl(optCtrl = list(maxfun = 1e6)))
  
  glmm.etd3.resp <- re_fit(glmm.etd2.resp)

} else {
  load(file.etd2.resp)
}

print(summary(glmm.etd3.resp), corr = FALSE)
```





##### Optimal model
```{r}


```



#### Estimated marginal means
```{r}
# emm.resp <- emmeans(glmm.opt.resp, ~ Alignment | c(Congruency, Viewing))
# 
# data.frame(summary(emm.resp)) %>% 
#   select(Viewing, Congruency, Alignment, everything())

```


#### Plots 
```{r}
# emmip(glmm.opt.resp, Congruency ~ Alignment | Viewing, CIs = TRUE)


```



#### Contrasts
```{r}
# contrast(emm.resp, "pairwise", simple = "each", combine = TRUE, adjust = "bonferroni")
```

```{r}
# contrast(emm.resp, interaction = "pairwise", by = "Viewing")
```


### Sensitivity d'

```{r successive coding for all d}
load(file.path(folder.nesi, "P101_d_R.RData"))
d.R.all <- sdif_coding_P101(d.R.all)
```


#### The maximal model
```{r}
lmm.max.d <- lmer(dprime ~ Viewing * Congruency * Alignment * CFS_Cover + WithCatch + 
                    (1 + View_C + Con_C + Ali_C + View_Ali + Con_Ali + View_Con_Ali | Participant), # View_Con
                  data = d.R.all,
                  REML = FALSE,
                  control = lmerControl(optimizer = "bobyqa"))

print(summary(lmm.max.d), corr = TRUE)
```

```{r}
summary(rePCA(lmm.max.d))
```


#### The zero-correlation-parameter model
```{r}
lmm.zcp.d <- update(lmm.max.d,
                    formula = dprime ~ Viewing * Congruency * Alignment * CFS_Cover + WithCatch + 
                    (1 + View_C + Con_C + Ali_C + View_Ali + Con_Ali + View_Con_Ali || Participant))

print(summary(lmm.zcp.d), corr = FALSE)
```


#### The reduced model
```{r}
summary(rePCA(lmm.zcp.d))
```


```{r}
lmm.rdc.d <- update(lmm.max.d,
                    formula = dprime ~ Viewing * Congruency * Alignment * CFS_Cover + WithCatch + 
                    (1 + View_C + Con_C + Ali_C + View_Ali + Con_Ali || Participant))

print(summary(lmm.zcp.d), corr = FALSE)
```



```{r}
lmm.rdc1.d <- update(lmm.zcp.d,
                    formula = dprime ~ Viewing * Congruency * Alignment * CFS_Cover + WithCatch + 
                    (1 + View_C + Con_C + Ali_C + View_Con + View_Ali + Con_Ali || Participant))

print(summary(lmm.rdc1.d), corr = FALSE)
```

```{r}
anova(lmm.rdc.d, lmm.zcp.d)
```


#### The extended model
```{r}
lmm.etd.d <- update(lmm.rdc.d,
                    formula = dprime ~ Viewing * Congruency * Alignment * CFS_Cover + WithCatch +
                    (1 + View_C + Con_C + Ali_C + View_Con + View_Ali + Con_Ali | Participant))

print(summary(lmm.etd.d), corr = FALSE)
```

```{r}
summary(rePCA(lmm.etd.d))

lmm.etd.d.step <- step(lmm.etd.d, reduce.fixed = FALSE)
```


```{r}
lmm.etd1.d <- update(lmm.etd.d,
                    formula = dprime ~ Viewing * Congruency * Alignment * CFS_Cover + WithCatch +
                    (1 + View_C + Con_C + Con_Ali | Participant))

print(summary(lmm.etd1.d), corr = FALSE)
```


#### The optimal model
```{r}
lmm.opt.d <- update(lmm.etd1.d,
                    REML = TRUE)

summary(lmm.opt.d)
```


#### Disgnostic plots
```{r}
qqplot_lmer(lmm.opt.d)
```

#### Estimated marginal means

```{r}
emm.d.all <- emmeans(lmm.opt.d, ~ Alignment | c(Congruency, Viewing, CFS_Cover))
data.frame(summary(emm.d.all)) %>% 
  select(Viewing, Congruency, Alignment, everything())
```


```{r}
emmip(emm.d.all, Congruency ~ Alignment | c(CFS_Cover, Viewing), CIs = TRUE)

```


```{r}
contrast(emm.d.all, "pairwise", simple = "each", combine = TRUE, adjust = "none")
```

```{r}
contrast(emm.d.all, interaction = "pairwise", by = c("Viewing", "CFS_Cover"), adjust = "bonferroni")

```



### Correct response times
```{r}
df.cf.rt <- {
  df.cf.all %>% 
    filter(isCorrect == 1)
}

```


#### Linear mixed model
##### The maximal model
```{r maximal model for correct RT }
# maximal model for correct RT
file.max.rt <- file.path(folder.nesi, "P101_rt_lmm_max.RData")

if (!file.exists(file.max.rt)) {
  lmm.max.rt <- lmer(reactionTime ~ Viewing * Congruency * Alignment * CFS_Cover + WithCatch + 
                           (1 + View_C + Con_C + Ali_C + View_Con + View_Ali + Con_Ali + View_Con_Ali | Participant) +
                           (1 + View_C + Ali_C + Cover_C + View_Ali + View_Cover + Ali_Cover + View_Ali_Cover | Stimuli),
                     data = df.cf.rt,
                     REML = FALSE,
                     # verbose = TRUE,
                     control = lmerControl(optCtrl = list(maxfun = 1e6))  # optimizer = "bobyqa",
  )
    save(lmm.max.rt, file = file.max.rt)
} else {
    load(file.max.rt)
}

print(summary(lmm.max.rt), corr = FALSE)
```

##### The zcp model
```{r zcp model for correct RT }
# zcp model for correct RT
file.zcp.rt <- file.path(folder.nesi, "P101_rt_lmm_zcp.RData")

if (!file.exists(file.zcp.rt)) {
  lmm.zcp.rt <- update(lmm.max.rt,
                       formula = reactionTime ~ Viewing * Congruency * Alignment * CFS_Cover + WithCatch + 
                           (1 + View_C + Con_C + Ali_C + View_Con + View_Ali + Con_Ali + View_Con_Ali || Participant) +
                           (1 + View_C + Ali_C + Cover_C + View_Ali + View_Cover + Ali_Cover + View_Ali_Cover || Stimuli))
} else {
    load(file.zcp.rt)
}

print(summary(lmm.zcp.rt), corr = FALSE)
```

##### The reduced model
```{r}

# zcp model for correct RT
file.zcp.rt.step <- file.path(folder.nesi, "P101_rt_lmm_zcp_step.RData")

if (!file.exists(file.zcp.rt.step)) {
  lmm.zcp.rt.step <- step(lmm.zcp.rt, reduce.fixed = FALSE)
} else {
    load(file.zcp.rt.step)
}

lmm.zcp.rt.step

```


```{r}
lmm.rdc.rt <- get_model(lmm.zcp.rt.step)

print(summary(lmm.rdc.rt), corr = FALSE)
```

##### The extended model
```{r etd model for correct RT }
# extended model for correct RT
file.etd.rt <- file.path(folder.nesi, "P101_rt_lmm_etd.RData")

if (!file.exists(file.etd.rt)) {
  lmm.etd.rt <- update(lmm.zcp.rt,
                       formula = reactionTime ~ Viewing * Congruency * Alignment * CFS_Cover + WithCatch +
                         (1 + View_C | Participant) +
                         (1 + View_Cover | Stimuli),
                       verbose = FALSE)
} else {
    load(file.etd.rt)
}

print(summary(lmm.etd.rt), corr = FALSE)
```


```{r}
anova(lmm.etd.rt, lmm.rdc.rt)
```

##### The optimal model
```{r}
lmm.opt.rt <- update(lmm.etd.rt,
                     REML = TRUE,
                     verbose = FALSE)

summary(lmm.opt.rt)

```


##### Diagnostic plots
```{r}
qqnorm(residuals(lmm.opt.rt))
```

```{r}
qqplot_lmer(lmm.opt.rt)
```
Generalized linear mixed (log) model has to be used for RT. 

##### Estimated marginal means

```{r}
emm.rt.lmm <- emmeans(lmm.opt.rt, ~ Alignment | c(Congruency, Viewing, CFS_Cover))
data.frame(summary(emm.rt.lmm)) %>% 
  select(Viewing, Congruency, Alignment, everything())

```


```{r}
emmip(emm.rt.lmm, Congruency ~ Alignment | c(CFS_Cover, Viewing), CIs = TRUE)

```


```{r}
contrast(emm.rt.lmm, "pairwise", simple = "Congruency", adjust = "none")

# contrast(emm.rt.lmm, "pairwise", simple = "each", combine = TRUE, adjust = "bonferroni")

```

```{r}
contrast(emm.rt.lmm, interaction = "pairwise", by = c("Viewing", "CFS_Cover"), adjust = "bonferroni")

```




#### Log mixed model
##### Maximal model
```{r maximal model for correct RT }
# maximal model for correct RT
file.max.rt <- file.path(folder.nesi, "P101_rt_glmm_max.RData")

if (!file.exists(file.max.rt)) {
  glmm.max.rt <- glmer(reactionTime ~ Viewing * Congruency * Alignment * CFS_Cover + WithCatch + 
                           (1 + View_C + Con_C + Ali_C + View_Con + View_Ali + Con_Ali + View_Con_Ali | Participant) +
                           (1 + View_C + Ali_C + Cover_C + View_Ali + View_Cover + Ali_Cover + View_Ali_Cover | Stimuli),
                       data = df.cf.rt,
                       family = "poisson",
                       # verbose = TRUE,
                       control = glmerControl(optCtrl = list(maxfun = 1e6))
  )
  
  save(glmm.max.rt, file = file.max.rt)
} else {
  load(file.max.rt)
}

print(summary(glmm.max.rt), corr = FALSE)
```

##### The zero-correlation-parameter model
```{r zcp model for correct RT }
# zcp model for correct RT
file.zcp.rt <- file.path(folder.nesi, "P101_rt_glmm_zcp.RData")

if (!file.exists(file.zcp.rt)) {
    glmm.zcp.rt <- glmer(reactionTime ~ Viewing * Congruency * Alignment + ExpCode +
                              (1 + View_D + Con_D + Ali_D + View_Con + View_Ali + Con_Ali + View_Con_Ali || Participant),
                          data = df.cf.rt,
                          family = "poisson",
                          # verbose = TRUE,
                          control = glmerControl(optCtrl = list(maxfun = 1e6))
    )

} else {
    load(file.zcp.rt)
}

print(summary(lmm.zcp.rt), corr = FALSE)
```


# Versions of Packages Used
```{r versions}
rstudioapi::versionInfo()
sessionInfo()
```

